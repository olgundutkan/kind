apiVersion: v1
kind: ConfigMap
metadata:
  name: idp-local-proxy-template
  namespace: default
data:
  nginx.conf.template: |
    worker_processes  1;

    events {
      worker_connections  1024;
    }

    http {
      map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
      }

      server {
        listen ${PROXY_PORT};

        location / {
          proxy_http_version 1.1;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
          proxy_pass http://${LOCAL_DEV_HOST}:${LOCAL_DEV_PORT};
        }
      }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: idp-backend-proxy
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: idp-backend-proxy
  template:
    metadata:
      labels:
        app: idp-backend-proxy
    spec:
      containers:
      - name: nginx
        image: nginx:1.25.5-alpine
        imagePullPolicy: IfNotPresent
        command: ["/bin/sh", "-c"]
        args:
        - |
          apk add --no-cache gettext >/dev/null
          envsubst '$LOCAL_DEV_HOST $LOCAL_DEV_PORT $PROXY_PORT' \
            < /etc/nginx/templates/nginx.conf.template \
            > /etc/nginx/nginx.conf
          nginx -g 'daemon off;'
        env:
        - name: LOCAL_DEV_HOST
          value: host.docker.internal
        - name: LOCAL_DEV_PORT
          value: "3001"
        - name: PROXY_PORT
          value: "8080"
        ports:
        - containerPort: 8080
          name: http
        readinessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 3
          periodSeconds: 5
        volumeMounts:
        - name: template
          mountPath: /etc/nginx/templates
      volumes:
      - name: template
        configMap:
          name: idp-local-proxy-template
---
apiVersion: v1
kind: Service
metadata:
  name: idp-backend-local
  namespace: default
spec:
  selector:
    app: idp-backend-proxy
  ports:
  - name: http
    port: 80
    targetPort: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: idp-frontend-proxy
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: idp-frontend-proxy
  template:
    metadata:
      labels:
        app: idp-frontend-proxy
    spec:
      containers:
      - name: nginx
        image: nginx:1.25.5-alpine
        imagePullPolicy: IfNotPresent
        command: ["/bin/sh", "-c"]
        args:
        - |
          apk add --no-cache gettext >/dev/null
          envsubst '$LOCAL_DEV_HOST $LOCAL_DEV_PORT $PROXY_PORT' \
            < /etc/nginx/templates/nginx.conf.template \
            > /etc/nginx/nginx.conf
          nginx -g 'daemon off;'
        env:
        - name: LOCAL_DEV_HOST
          value: host.docker.internal
        - name: LOCAL_DEV_PORT
          value: "3000"
        - name: PROXY_PORT
          value: "8080"
        ports:
        - containerPort: 8080
          name: http
        volumeMounts:
        - name: template
          mountPath: /etc/nginx/templates
      volumes:
      - name: template
        configMap:
          name: idp-local-proxy-template
---
apiVersion: v1
kind: Service
metadata:
  name: idp-frontend-local
  namespace: default
spec:
  selector:
    app: idp-frontend-proxy
  ports:
  - name: http
    port: 80
    targetPort: 8080
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: idp-backend-strip
  namespace: default
spec:
  stripPrefix:
    prefixes:
    - /idp-backend
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: idp-frontend-trailing-slash
  namespace: default
spec:
  redirectRegex:
    regex: "^https?://([^/]+)/idp-frontend$"
    replacement: "https://$1/idp-frontend/"
    permanent: true
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: idp-local-app
  namespace: default
spec:
  entryPoints:
  - websecure
  routes:
  - match: Host(`local.portal.k2.io`) && PathPrefix(`/idp-backend`)
    kind: Rule
    services:
    - name: idp-backend-local
      port: 80
    middlewares:
    - name: idp-backend-strip
  - match: Host(`local.portal.k2.io`) && PathPrefix(`/idp-frontend`)
    kind: Rule
    services:
    - name: idp-frontend-local
      port: 80
    middlewares:
    - name: idp-frontend-trailing-slash
  tls:
    secretName: k2-io-tls
